name: AWS Deployment

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches:
      - master
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  APPLICATION_NAME: bp-calculator-app
  PYTHON_VERSION: "3.12"
  KEY_NAME: bp-py

jobs:
  # Check if CI passed
  check-ci:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    steps:
      - name: CI Passed
        run: echo "CI workflow passed, proceeding with deployment"

  # Build deployment package
  build-package:
    runs-on: ubuntu-latest
    needs: check-ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create deployment package
        run: |
          # Create deployment package with application code
          zip -r deployment.zip . \
            -x "*.git*" \
            -x "*.env" \
            -x "*venv/*" \
            -x "*tests/*" \
            -x "*htmlcov/*" \
            -x "*.pytest_cache/*" \
            -x "*__pycache__/*" \
            -x "*infrastructure/*" \
            -x "*.github/*"

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: deployment.zip

  # Infrastructure Deployment Job
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: build-package
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation stack
        run: |
          # Get branch name (remove refs/heads/ prefix)
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # Sanitize branch name for CloudFormation (alphanumeric and hyphens only)
          STACK_SUFFIX=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yml \
            --stack-name bp-calculator-$STACK_SUFFIX \
            --parameter-overrides \
              ApplicationName=${{ env.APPLICATION_NAME }} \
              KeyName=${{ env.KEY_NAME }} \
              BranchName=$STACK_SUFFIX \
              VpcId=vpc-0393d1315f5e64c75 \
              SubnetId=subnet-058dde5de2753fae4 \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }}
          
          echo "STACK_NAME=bp-calculator-$STACK_SUFFIX" >> $GITHUB_ENV

      - name: Get EC2 Instance DNS
        id: ec2
        run: |
          EC2_DNS=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='PublicDNS'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "instance_dns=$EC2_DNS" >> $GITHUB_OUTPUT
          echo "EC2 Instance DNS: $EC2_DNS"

  # Application Deployment Job
  deploy-application:
    runs-on: ubuntu-latest
    needs: [build-package, deploy-infrastructure]
    if: github.event_name != 'pull_request'

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: python-app

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 Instance ID
        id: instance
        run: |
          # Get branch name and sanitize
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          STACK_SUFFIX=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          STACK_NAME="bp-calculator-$STACK_SUFFIX"
          
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance ID: $INSTANCE_ID"
          echo "STACK_NAME=$STACK_NAME" >> $GITHUB_ENV

      - name: Deploy application to EC2
        run: |
          # Get instance ID
          INSTANCE_ID="${{ steps.instance.outputs.instance_id }}"
          
          # Copy deployment package to EC2 instance using SSM
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp",
              "rm -rf bp-calculator-deploy",
              "mkdir -p bp-calculator-deploy"
            ]' \
            --region ${{ env.AWS_REGION }}
          
          sleep 5
          
          # Upload file via S3 (temporary bucket for transfer)
          TEMP_BUCKET="bp-deploy-temp-${{ github.run_number }}"
          aws s3 mb s3://$TEMP_BUCKET --region ${{ env.AWS_REGION }} || true
          aws s3 cp deployment.zip s3://$TEMP_BUCKET/deployment.zip
          
          # Download and extract on EC2
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'cd /tmp/bp-calculator-deploy',
              'aws s3 cp s3://$TEMP_BUCKET/deployment.zip .',
              'unzip -o deployment.zip',
              'sudo cp /opt/bp-calculator/.env /tmp/bp-calculator-env-backup',
              'sudo rm -rf /opt/bp-calculator/*',
              'sudo cp -r * /opt/bp-calculator/',
              'sudo mv /tmp/bp-calculator-env-backup /opt/bp-calculator/.env',
              'cd /opt/bp-calculator',
              'pwd;whoami',
              'sudo python3 -m venv venv',
              'sudo /opt/bp-calculator/venv/bin/pip install --upgrade pip',
              'sudo /opt/bp-calculator/venv/bin/pip install -r requirements.txt',
              'sudo systemctl restart bp-calculator.service',
              'sleep 3',
              'sudo systemctl status bp-calculator.service'
            ]" \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          sleep 10
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }} || true
          
          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }}
          
          # Cleanup temp S3 bucket
          aws s3 rb s3://$TEMP_BUCKET --force --region ${{ env.AWS_REGION }} || true

  # E2E Tests Job (runs after deployment)
  e2e-tests:
    runs-on: ubuntu-latest
    needs: deploy-application
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get install -y libasound2t64
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Environment URL
        id: ec2
        run: |
          # Get branch name and sanitize
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          STACK_SUFFIX=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          STACK_NAME="bp-calculator-$STACK_SUFFIX"
          
          EC2_DNS=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='PublicDNS'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "BASE_URL=http://$EC2_DNS" >> $GITHUB_ENV
          echo "Application URL: http://$EC2_DNS"

      - name: Wait for application to be ready
        run: |
          echo "Waiting for application to be ready..."
          sleep 30

      - name: Run E2E tests
        run: |
          mkdir -p test-results
          pytest tests/e2e/ -v --tb=short \
            --html=test-results/report.html \
            --self-contained-html \
            --junit-xml=test-results/junit.xml
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
        if: always()
